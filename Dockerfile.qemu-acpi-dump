# Copyright (c) 2025-2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

ARG DISTRIBUTION=ubuntu:25.04
FROM ${DISTRIBUTION}

ARG QEMU_VERSION
ARG ACPI_TABLES_NAME

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install --no-install-recommends --yes \
        build-essential \
        git \
        ubuntu-dev-tools \
        libglib2.0-dev \
        meson \
        python3-venv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Download QEMU source from Canonicals ppa:kobuk-team/tdx-release pacakge repository, which provides Intel TDX-enabled QEMU builds for Ubuntu 24.04 and 25.04
RUN pull-ppa-source --ppa ppa:kobuk-team/tdx-release qemu ${QEMU_VERSION}

RUN QEMU_WRK_DIR=$(find / -maxdepth 1 -type d -name "qemu*" | head -n 1) && \
    echo "Found QEMU directory: $QEMU_WRK_DIR" && \
    ln -s "$QEMU_WRK_DIR" /qemu-source && \
    useradd -m -s /sbin/nologin qemu-user && \
    chown -R qemu-user:qemu-user "$QEMU_WRK_DIR"

WORKDIR /qemu-source

USER qemu-user

# Patch QEMU source to dump ACPI tables: inject code to write ACPI tables to /output/, force EOI intercept to 1, and skip pc-bios/tests builds
ARG acpi_tables_dump_loc='\n\n    int fd = open("\/output\/'"${ACPI_TABLES_NAME}"'", O_CREAT | O_WRONLY, S_IRUSR | S_IWUSR);\n    if(fd != -1) {\n        int ret = write(fd, (uint8_t *)tables.table_data->data, tables.table_data->len);\n        if (ret < tables.table_data->len) {\n            printf("Error: Failed to write the acpi tables\\n");\n        } else {\n            printf("Successfully wrote the acpi tables to the file \\"'"${ACPI_TABLES_NAME}"'\\"\\n");\n        }\n    } else {\n        printf("Error: Failed to create acpi_tables file.\\n");\n    }\n    exit(0);'
ARG acpi_build_c="hw/i386/acpi-build.c"
ARG acpi_common_c="hw/i386/acpi-common.c"
ARG meson_build="meson.build"

RUN perl -i -0pe 's/(acpi_build_update\(void \*build_opaque\)[\s\S]*?acpi_build\([^;]*;)/\1'"$acpi_tables_dump_loc"'/gs' "$acpi_build_c" && \
    perl -i -pe 's/x86ms->eoi_intercept_unsupported;/1;/g' "$acpi_build_c" "$acpi_common_c" && \
    perl -i -pe "s/(^subdir\('pc-bios'\)|^subdir\('tests'\))/# \1/g" "$meson_build"

# Configure QEMU with minimal features to reduce build time and image size - only KVM acceleration is needed for ACPI table generation
RUN ./configure \
    --disable-bsd-user \
    --disable-guest-agent \
    --disable-strip \
    --disable-werror \
    --disable-gcrypt \
    --disable-debug-info \
    --disable-debug-tcg \
    --disable-docs \
    --disable-tcg-interpreter \
    --enable-attr \
    --disable-brlapi \
    --disable-linux-aio \
    --disable-bzip2 \
    --disable-cap-ng \
    --disable-curl \
    --disable-glusterfs \
    --disable-gnutls \
    --disable-nettle \
    --disable-gtk \
    --disable-rdma \
    --disable-libiscsi \
    --disable-vnc-jpeg \
    --enable-kvm \
    --disable-lzo \
    --disable-curses \
    --disable-libnfs \
    --disable-numa \
    --disable-opengl \
    --disable-rbd \
    --disable-vnc-sasl \
    --disable-sdl \
    --disable-seccomp \
    --disable-smartcard \
    --disable-snappy \
    --disable-spice \
    --disable-libusb \
    --disable-usb-redir \
    --disable-vde \
    --disable-vhost-net \
    --disable-virglrenderer \
    --disable-virtfs \
    --disable-vnc \
    --disable-vte \
    --disable-xen \
    --disable-xen-pci-passthrough \
    --disable-tools \
    --target-list=x86_64-softmmu

RUN make -j$(nproc)

# Add health check for container monitoring
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ["build/qemu-system-x86_64", "--version"]

ENTRYPOINT ["build/qemu-system-x86_64"]
